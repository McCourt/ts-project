---
title: "Final Project"
author: "McCourt Hu, Lin Zuo, Jingyi Zhang, Yuanling Wang"
date: "12/8/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(mosaic)
library(forecast)
library(grid)
library(gridExtra)
library(rugarch)
library(scoringRules)
library(forcats)

set.seed(20181208)
df = read.csv("data.csv")
df$Open = as.numeric(as.character(df$Open))
df$High = as.numeric(as.character(df$High))
df$Low = as.numeric(as.character(df$Low))
df$Close = as.numeric(as.character(df$Close))
df$Adj.Close = as.numeric(as.character(df$Adj.Close))
df$Volume = as.numeric(as.character(df$Volume))
df$Date = as.Date(df$Date, format = "%d/%m/%Y")
df = df[complete.cases(df), ]

#create a column `Diff` that represents the difference between close price and open price
df$Diff = df$Close - df$Open

rmse = function(pred, truth){
  sqrt(mean((pred - truth)^2))
}

```

## Introduction

For this particular project, we are looking at the stock prices of four major tech companies: Apple, Facebook, Amazon and Google, from the years of, correspondingly, 1980, 2012, 1997 and 2004 to the year of 2018. With the data downloaded from Kaggle (*https://www.kaggle.com/stexo92/gafa-stock-prices*), we got access to the dates, opening prices, closing prices, stock volume, highest/lowest prices and adjusted close prices of these companies.

Based on the nature of stock market, there can potentially be temporal structures when analyzing and predicting stock prices. We take the difference between the opening and the closing prices of the stocks as the response variable and try to fit appropriate models to help determine what affects the change in stock prices each day for each company, as well as understanding the temporal structures within.

We will first look at some Explanatory Data Analyses for all four companies, then try to fit simpler models with no temporal structures, and finally fit and evaluate temporal models for each company. For the temporal model fitting part specifically, we will try two different methods: both auto-fitting ARIMA models, as well as models with Gaussian Process. We would then compare the performances of all three types models fit by both methods.

Lastly, we wish to come to a conclusion for our questions of interest: what are the factors that can potentially affect the closing prices of stocks? Is there any temporal dependency in the closing prices? Are there differences among different companies or they share similar trends and structures in their stocks?  We would also have a discussion on the adequacy, potential problems with the models and provide suggestions for developing this project.

## Exploratory Data Analysis

```{r message=FALSE}
summary(df)

ggplot(data = cor(df %>% select(Close, Open, Volume, High, Low)) %>% reshape2::melt(), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile() +
  ggtitle("Correltion matrix")

cor(df$Open, df$Close)
```

Among all variables available in the dataset, we only focused on two variables `Date` and `Close`. Reasons why we didn't use other variables are as follows:
1. `Open`: The correlation between variables `Open` and `Close` is almost one. This result intuitively makes sense because the average magnitude of daily stock price fluctuation is minimal compared with stock price itself. However, since `Open` and `Close` are almost perfectly correlated, we thought that using `Open` as the predictor for `Close` will not help us understand the research question that we're interested. Therefore, we didn't include `Open` in our analysis.
2. `High` & `Low` & `Volume`: These three variables are numbers that can only be revealed at the end of each trading day, when the value for `Close` is also revealed. In another word, there's no way for us to know `High`, `Low` or `Volume` ahead of knowing `Close`. Therefore, it doesn't make sense to include any of these as covariates in the model to predict `Close`.
3. `Adj. Close`: The dataset we downloaded doesn't include a data dictionary about what adjustment is made to `Close`, so we weren't able to use it.

```{r message=FALSE}
ggplot(data = df, aes(x = Stock, y = Close)) +
  geom_boxplot() +
  ggtitle("Different Close Price Distribution of Different Stocks")

p1 = ggplot(data = df %>% filter(Stock == "Amazon") %>% arrange(Date), aes(x = Date, y = Close)) +
  geom_line() +
  ggtitle("Stock Close Price of Amazon")
p2 = ggplot(data = df %>% filter(Stock == "Apple") %>% arrange(Date), aes(x = Date, y = Close)) +
  geom_line() +
  ggtitle("Stock Close Price of Apple")
p3 = ggplot(data = df %>% filter(Stock == "Google") %>% arrange(Date), aes(x = Date, y = Close)) +
  geom_line() +
  ggtitle("Stock Close Price of Google")
p4 = ggplot(data = df %>% filter(Stock == "Facebook") %>% arrange(Date), aes(x = Date, y = Close)) +
  geom_line() +
  ggtitle("Stock Close Price of Facebook")
grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)
```

These four companies went to public at very different times, so date ranges for each company in this dataset are very different. From the boxplot, we can see that Amazon, Apple and Google's `Close` are skewed while Facebook's `Close` price is not as skewed as that of the other three companies. From line plots, we can see that before 2005, Amazon and Apple's `Close` are horizontal lines, meaning that there weren't many changes. However, starting in 2005, all four companies experienced dramatic growth in their `Close`. This observation makes sense because of the Internet's boom. To better compare all four companies' close stock price, we decided to align date ranges for them by taking a subset of observations with a date after 2012-08-05 and build models with the subset.

## Method 1: Simple Linear Models

The first method is fitting a simple linear model for each individual company. We used the data to predict the difference between the close price and the open price on each day. Since each day would have price data for all four companies, we would have to build four individual time series models. For the sake of comparing and evaluating model performances, we fit four different linear models as well, instead of using `Stock` as one of the predictors.

```{r}
#Apple
apple.stock = df %>% filter(Stock == "Apple" & Date>="2012-08-05" & Date<="2018-12-31")
apple.lm = lm(Diff ~ Date, data = apple.stock)
summary(apple.lm)

#Amazon
amazon.stock = df %>% filter(Stock == "Amazon" & Date>="2012-08-05" & Date<="2018-12-31")
amazon.lm = lm(Diff ~ Date, data = amazon.stock)
summary(amazon.lm)

#Facebook
facebook.stock = df %>% filter(Stock == "Facebook" & Date>="2012-08-05" & Date<="2018-12-31")
facebook.lm = lm(Diff ~ Date, data = facebook.stock)
summary(facebook.lm)

#Google
google.stock = df %>% filter(Stock == "Google" & Date>="2012-08-05" & Date<="2018-12-31")
google.lm = lm(Diff ~ Date, data = google.stock)
summary(google.lm)
```


## Method 2: ARIMA Time Series Models

$$
\begin{aligned}
Close_t &= ARIMA_{(p, q, d) \times (P, Q, D)_s}(Close_{t-1, \cdots}) + \beta_s
\end{aligned}
$$

```{r}
amazon.ts = auto.arima(amazon.stock %>% select(Diff), seasonal = TRUE)
amazon.ts %>% summary()
ggtsdisplay(amazon.ts$residuals, main = "ARIMA(3,0,3)")

amazon.stock$ts.residuals = amazon.ts$residuals

res.lm.model = lm(data = amazon.stock, formula = ts.residuals ~ 1)
res.lm.model %>% summary()

amazon.stock$ts.pred = amazon.ts$fitted + res.lm.model$fitted.values
amazon.stock$residuals = c(amazon.stock$Diff - amazon.stock$ts.pred)

ggplot(data = amazon.stock, aes(x = Date)) +
  geom_line(aes(y = Diff, color = "red")) +
  geom_line(aes(y = ts.pred, color = "blue")) +
  xlab("time") +
  ylab("Difference in Close Price and Open Price of Amazon Stock") +
  ggtitle("ARIMA(3,0,3)")

rmse(amazon.stock$Diff, amazon.stock$naive.pred)
rmse(amazon.stock$Diff, amazon.stock$ts.pred)
forecast(amazon.ts, 30) %>% plot(xlim=c(1250, 1520))
plot(amazon.stock$residuals, ylab = "Residuals", main = "Residual Plot of ARIMA")
```


```{r}
apple.ts = auto.arima(apple.stock %>% select(Diff), seasonal = TRUE)
apple.ts %>% summary()
ggtsdisplay(apple.ts$residuals, main = "ARIMA(1,1,0)")

apple.stock$ts.residuals = apple.ts$residuals

res.lm.model = lm(data = apple.stock, formula = ts.residuals ~ 1)
res.lm.model %>% summary()

apple.stock$ts.pred = apple.ts$fitted + res.lm.model$fitted.values
apple.stock$residuals = apple.stock$Diff - apple.stock$ts.pred

ggplot(data = apple.stock, aes(x = Date)) +
  geom_line(aes(y = Diff, color = "red")) +
  geom_line(aes(y = ts.pred, color = "blue")) +
  xlab("time") +
  ylab("Difference in Close Price and Open Price of Apple Stock") +
  ggtitle("ARIMA(1,1,0)")

rmse(apple.stock$Diff, apple.stock$naive.pred)
rmse(apple.stock$Diff, apple.stock$ts.pred)
forecast(apple.ts, 30) %>% plot(xlim=c(1250, 1520))
plot(apple.ts$residuals, ylab = "Residuals", main = "Residual Plot of ARIMA")
```

```{r}
facebook.ts = auto.arima(facebook.stock %>% select(Diff), seasonal = TRUE)
facebook.ts %>% summary()
ggtsdisplay(facebook.ts$residuals, main = "ARIMA(2,0,2)")

facebook.stock = facebook.stock %>% mutate(ts.residuals = facebook.ts$residuals)

res.lm.model = lm(data = facebook.stock, formula = ts.residuals ~ 1)
res.lm.model %>% summary()

facebook.stock = facebook.stock %>% 
  mutate(ts.pred = facebook.ts$fitted + res.lm.model$fitted.values)
facebook.stock$residuals = c(facebook.stock$Diff - facebook.stock$ts.pred)

ggplot(data = facebook.stock, aes(x = Date)) +
  geom_line(aes(y = Diff, color = "red")) +
  geom_line(aes(y = ts.pred, color = "blue")) +
  xlab("time") +
  ylab("Difference in Close Price and Open Price of Facebook Stock") +
  ggtitle("ARIMA(2,0,2)")

rmse(facebook.stock$Diff, facebook.stock$naive.pred)
rmse(facebook.stock$Diff, facebook.stock$ts.pred)
forecast(facebook.ts, 30) %>% plot(xlim=c(1250, 1520))
plot(facebook.ts$residuals, ylab = "Residuals", main = "Residual Plot of ARIMA")
```

```{r}
google.ts = auto.arima(google.stock %>% select(Diff), seasonal = TRUE)
google.ts %>% summary()
ggtsdisplay(google.ts$residuals, main = "ARIMA(3,0,3)")

google.stock = google.stock %>% mutate(ts.residuals = google.ts$residuals)


res.lm.model = lm(data = google.stock, formula = ts.residuals ~ 1)
res.lm.model %>% summary()

google.stock = google.stock %>% 
  mutate(ts.pred = google.ts$fitted + res.lm.model$fitted.values)
google.stock$residuals = c(google.stock$Diff - google.stock$ts.pred)

ggplot(data = google.stock, aes(x = Date)) +
  geom_line(aes(y = Diff, color = "red")) +
  geom_line(aes(y = ts.pred, color = "blue")) +
  xlab("time") +
  ylab("Difference in Close Price and Open Price of Google Stock") +
  ggtitle("ARIMA(3,0,3)")

rmse(google.stock$Diff, google.stock$naive.pred)
rmse(google.stock$Diff, google.stock$ts.pred)
forecast(google.ts, 30) %>% plot(xlim=c(1250, 1520))
plot(google.ts$residuals, ylab = "Residuals", main = "Residual Plot of ARIMA")
```


## Method 3: Gaussian Process

###Empirical Semivariogram
```{r echo=FALSE, fig.height=4.5}
source("util.R")
apple_emp_cloud = apple.stock %>% emp_semivariogram(Diff,Date)

apple_emp = rbind(
  apple.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.05)  %>% mutate(binwidth="binwidth=0.05"),
  apple.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.075) %>% mutate(binwidth="binwidth=0.075"),
  apple.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.1)   %>% mutate(binwidth="binwidth=0.1"),
  apple.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.15)  %>% mutate(binwidth="binwidth=0.15")
)

apple_emp %>%
  ggplot(aes(x=h, y=gamma)) +
  geom_point(size = 1) +
  ggtitle("Empirical Semivariogram of Apple (binned)")+
  facet_wrap(~binwidth, nrow=2)
```

```{r}
gp_model = "model{
  y ~ dmnorm(0, inverse(Sigma))
  
  for (i in 1:(N-1)) {
    for (j in (i+1):N) {
      Sigma[i,j] <- sigma2 * exp(- pow(l*d[i,j],2))
      Sigma[j,i] <- Sigma[i,j]
    }
  }

  for (k in 1:N) {
    Sigma[k,k] <- sigma2 + sigma2_w
  }

  sigma2_w ~ dnorm(5, 1/25) T(0,)
  sigma2   ~ dnorm(12.5, 1/25) T(0,)
  l        ~ dt(0, 2.5, 1) T(0,) 
}"

m = rjags::jags.model(
    textConnection(gp_model), 
    data = list(
      y = apple.stock$Diff,
      x = apple.stock$Date,
      d = dist(apple.stock$Date) %>% as.matrix(),
      N = nrow(apple.stock),
      coef = coef(l)
    ),
    quiet = TRUE
  )

  update(m, n.iter=10000)

  exp_cov_coda = rjags::coda.samples(
    m, variable.names=c("sigma2", "l", "sigma2_w"),
    n.iter=10000, thin=10
  )
  save(exp_cov_coda, file="gp_jags.Rdata")
```


```{r echo=FALSE, fig.height=4.5}
amazon_emp_cloud = amazon.stock %>% emp_semivariogram(Diff,Date)

amazon_emp = rbind(
  amazon.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.05)  %>% mutate(binwidth="binwidth=0.05"),
  amazon.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.075) %>% mutate(binwidth="binwidth=0.075"),
  amazon.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.1)   %>% mutate(binwidth="binwidth=0.1"),
  amazon.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.15)  %>% mutate(binwidth="binwidth=0.15")
)

amazon_emp %>%
  ggplot(aes(x=h, y=gamma)) +
  geom_point(size = 1) +
  ggtitle("Empirical Semivariogram of Amazon (binned)")+
  facet_wrap(~binwidth, nrow=2)
```

```{r echo=FALSE, fig.height=4.5}
facebook_emp_cloud = facebook.stock %>% emp_semivariogram(Diff,Date)

facebook_emp = rbind(
  facebook.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.05)  %>% mutate(binwidth="binwidth=0.05"),
  facebook.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.075) %>% mutate(binwidth="binwidth=0.075"),
  facebook.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.1)   %>% mutate(binwidth="binwidth=0.1"),
  facebook.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.15)  %>% mutate(binwidth="binwidth=0.15")
)

facebook_emp %>%
  ggplot(aes(x=h, y=gamma)) +
  geom_point(size = 1) +
  ggtitle("Empirical Semivariogram of Facebook (binned)")
  facet_wrap(~binwidth, nrow=2)
```

```{r echo=FALSE, fig.height=4.5}
google_emp_cloud = google.stock %>% emp_semivariogram(Diff,Date)

google_emp = rbind(
  google.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.05)  %>% mutate(binwidth="binwidth=0.05"),
  google.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.075) %>% mutate(binwidth="binwidth=0.075"),
  google.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.1)   %>% mutate(binwidth="binwidth=0.1"),
  google.stock %>% emp_semivariogram(Diff, Date, bin=TRUE, binwidth=0.15)  %>% mutate(binwidth="binwidth=0.15")
)

google_emp %>%
  ggplot(aes(x=h, y=gamma)) +
  geom_point(size = 1) +
  ggtitle("Empirical Semivariogram of Apple (binned)")
  facet_wrap(~binwidth, nrow=2)
```


## Conclusion

## Discussion
